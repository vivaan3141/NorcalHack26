<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClarifyEDU | AI Assignment Feedback</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #1e293b;
            --muted: #64748b;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        .header { text-align: center; margin-bottom: 20px; }
        h1 { color: var(--primary); font-size: 2.2rem; margin: 0; letter-spacing: -1px; }
        
        /* Compact Settings & Action Bar */
        .control-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            background: var(--card);
            padding: 15px 25px;
            border-radius: 16px;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            position: sticky;
            top: 10px;
            z-index: 100;
        }

        .tone-group { display: flex; align-items: center; gap: 10px; }
        
        select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            font-size: 0.9rem;
            cursor: pointer;
        }

        #auditBtn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        #auditBtn:hover { background: var(--primary-hover); transform: scale(1.02); }
        #auditBtn:disabled { background: #94a3b8; cursor: not-allowed; }

        /* Input Grid */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .input-group { background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        label { display: block; font-weight: 700; margin-bottom: 8px; font-size: 0.85rem; color: var(--primary); text-transform: uppercase; }
        
        textarea {
            width: 100%;
            height: 200px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            resize: vertical;
            box-sizing: border-box;
            font-family: inherit;
            font-size: 0.9rem;
        }

        .drop-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            background: #f8fafc;
            margin-top: 10px;
            font-size: 0.8rem;
        }
        #filePicker { display: none; }

        /* Output Area Formatting */
        #output {
            margin-top: 25px;
            background: white;
            padding: 40px;
            border-radius: 16px;
            border-top: 5px solid var(--primary);
            display: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        /* Markdown Styles */
        .res-h1 { color: var(--primary); font-size: 1.5rem; border-bottom: 2px solid #eee; margin-top: 20px; }
        .res-h2 { color: #334155; font-size: 1.2rem; margin-top: 15px; }
        .res-li { margin-left: 20px; list-style-type: disc; margin-bottom: 5px; }
        .loading-spinner { font-style: italic; color: var(--primary); text-align: center; padding: 20px; }
    </style>
</head>
<body>

    <div class="header">
        <h1>üéì Clarify - Education</h1>
    </div>

    <div class="control-panel">
        <div class="tone-group">
            <label style="margin:0;">Tone:</label>
            <select id="toneSelect">
                <option value="Chill">Chill</option>
                <option value="Strict">Strict</option>
                <option value="Technical">Technical</option>
            </select>
        </div>
        <button id="auditBtn">üöÄ Get Feedback</button>
    </div>

    <div class="grid">
        <div class="input-group">
            <label>1. Instructions / Rubric</label>
            <textarea id="promptInput" placeholder="What does the teacher want?"></textarea>
        </div>

        <div class="input-group">
            <label>2. Your Work</label>
            <textarea id="workInput" placeholder="Paste your draft here..."></textarea>
            
            <div class="drop-zone" id="dropZone">
                <span id="fileLabel">üìÅ Or Upload PDF/DOCX</span>
                <input type="file" id="filePicker" accept=".pdf,.docx,.txt">
            </div>
        </div>
    </div>

    <div id="output"></div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        const API_KEY = "AIzaSyBYxtGKWVKYGTAZbvkdaxlzZ1BvwSGKPq4";

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        const dropZone = document.getElementById('dropZone');
        const filePicker = document.getElementById('filePicker');
        const output = document.getElementById('output');
        const auditBtn = document.getElementById('auditBtn');

        dropZone.onclick = () => filePicker.click();

        async function extractText(file) {
            if (file.type === "text/plain") return await file.text();
            if (file.type === "application/pdf") {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let text = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(s => s.str).join(" ") + " ";
                }
                return text;
            }
            if (file.name.endsWith('.docx')) {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer });
                return result.value;
            }
            return "";
        }

        // Helper to turn AI Markdown into HTML
        function formatMarkdown(text) {
            return text
                .replace(/^### (.*$)/gim, '<h3 class="res-h2">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="res-h1">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 class="res-h1">$1</h1>')
                .replace(/^\* (.*$)/gim, '<div class="res-li">$1</div>')
                .replace(/^- (.*$)/gim, '<div class="res-li">$1</div>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
        }

        auditBtn.onclick = async () => {
            const userPrompt = document.getElementById('promptInput').value;
            const tone = document.getElementById('toneSelect').value;
            let work = document.getElementById('workInput').value;

            if (!userPrompt) return alert("Please add the instructions!");

            auditBtn.disabled = true;
            output.style.display = "block";
            output.innerHTML = `<div class="loading-spinner">Analyzing... sit tight!</div>`;
            
            // Auto-scroll to loading message
            output.scrollIntoView({ behavior: 'smooth' });

            try {
                if (filePicker.files.length > 0) {
                    work = await extractText(filePicker.files[0]);
                }

                if (!work) throw new Error("Need some work to review!");

                const genAI = new GoogleGenerativeAI(API_KEY);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

                const finalPrompt = `
                    Act as an academic mentor with a ${tone} tone. 
                    Review the STUDENT WORK based on the INSTRUCTIONS/RUBRIC.
                    
                    Use clear Markdown headers (##) for sections.
                    
                    INSTRUCTIONS: ${userPrompt}
                    STUDENT WORK: ${work}

                    Provide:
                    ## Met Requirements
                    ## Missing/Weak Elements
                    ## Growth Pointers (8 tips)
                `;

                const result = await model.generateContent(finalPrompt);
                const responseText = result.response.text();
                
                output.innerHTML = formatMarkdown(responseText);
                
                // Final scroll to result
                output.scrollIntoView({ behavior: 'smooth' });
                
            } catch (err) {
                output.innerHTML = `<span style="color:red">Error: ${err.message}</span>`;
            } finally {
                auditBtn.disabled = false;
            }
        };
    </script>
</body>
</html>
